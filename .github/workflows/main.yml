name: Build and Push All Backend Services to ECR

on:
  push:
    branches: [ "main" ]
    paths:
      - "**"
      - ".github/workflows/**"

  repository_dispatch:
    types: [infra-ready]

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      ECR_REGISTRY: 337112169365.dkr.ecr.us-east-1.amazonaws.com
      IMAGE_TAG: ${{ github.sha }}

      # ÌòïÏãù: <manifest ÌååÏùºÎ™Ö> <backend ÎîîÎ†âÌÑ∞Î¶¨ & ecr suffix>
      SERVICES: |
        users user-api
        products product-api
        orders order-api
        carts cart-api
        payments payment-api
        lex lex-api

    steps:
      # ============================================================
      # 1Ô∏è‚É£ Backend repo checkout
      # ============================================================
      - name: Checkout backend repository
        uses: actions/checkout@v3

      # ============================================================
      # 2Ô∏è‚É£ AWS Ïù∏Ï¶ù
      # ============================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================================
      # 3Ô∏è‚É£ ECR Î°úÍ∑∏Ïù∏
      # ============================================================
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ============================================================
      # 4Ô∏è‚É£ Docker build & ECR push
      # ============================================================
      - name: Build & Push all microservices images
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          set -e
          while IFS=' ' read -r manifest repo; do
            [ -z "$manifest" ] && continue
            [ -z "$repo" ] && continue

            echo "========================================"
            echo "Building service: ${repo}"
            echo "Image tag: ${IMAGE_TAG}"
            echo "========================================"

            if [ ! -f "./${repo}/Dockerfile" ]; then
              echo "‚ùå Dockerfile not found: ./${repo}/Dockerfile ‚Äî skipping"
              continue
            fi

            IMAGE_URI="${REGISTRY}/sb3-u2-blossom/${repo}:${IMAGE_TAG}"

            docker build -f "${repo}/Dockerfile" -t "${IMAGE_URI}" .
            docker push "${IMAGE_URI}"

            echo "‚úî Pushed: ${IMAGE_URI}"
            echo ""
          done <<< "$SERVICES"

      # ============================================================
      # 5Ô∏è‚É£ manifests repo Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ (ÌïµÏã¨ ÏàòÏ†ï Î∂ÄÎ∂Ñ)
      # ============================================================
      - name: Update image tag in manifests repository
        env:
          MANIFEST_TOKEN: ${{ secrets.blossommanifestToken }}
        run: |
          set -e
          git clone https://x-access-token:${MANIFEST_TOKEN}@github.com/jihyun2256/blossommanifest.git manifests
          cd manifests

          while IFS=' ' read -r manifest repo; do
            [ -z "$manifest" ] && continue
            [ -z "$repo" ] && continue

            YAML_FILE="apps/${manifest}.yaml"
            NEW_IMAGE="${ECR_REGISTRY}/sb3-u2-blossom/${repo}:${IMAGE_TAG}"

            if [ ! -f "$YAML_FILE" ]; then
              echo "‚ùå ${YAML_FILE} not found ‚Äî skipping"
              continue
            fi

            echo "‚ñ∂ Updating ${YAML_FILE}"
            echo "üîç Before:"
            grep "image:" "$YAML_FILE" || true

            # ÏïàÏ†ÑÌïú image ÏπòÌôò (repo Í∏∞Ï§Ä)
            sed -i "s|image: .*sb3-u2-blossom/${repo}:.*|        image: ${NEW_IMAGE}|g" "$YAML_FILE"

            echo "‚úÖ After:"
            grep "image:" "$YAML_FILE" || true
            echo ""
          done <<< "$SERVICES"

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          if git status --porcelain | grep .; then
            git add apps/*.yaml
            git commit -m "chore: update image tags to ${IMAGE_TAG}"
            git push origin main
          else
            echo "‚ÑπÔ∏è No changes detected"
          fi
